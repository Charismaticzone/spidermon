{% extends 'reports/email/pages/medium.jinja' %}
{% import 'reports/email/ui.jinja' as ui%}

{% macro render_dash_link() %}
    {% if data.job %}
        <a class="btn btn-info pull-right" href="https://dash.scrapinghub.com/p/{{ data.job.key.split('/')[0] }}/job/{{ data.job.key.split('/')[1] }}/{{ data.job.key.split('/')[2] }}" target="_blank">
            See job in Dash
        </a>
    {% endif %}
{% endmacro %}

{% macro render_status_icon(status) -%}
    {% if status == 'OK' %}
        <i class="fa fa-check fa-3x"></i>
    {% elif status == 'FAIL' %}
        <i class="fa fa-times fa-3x"></i>
    {% else %}
        <i class="fa fa-frown-o fa-3x"></i>
    {% endif %}
{%- endmacro %}

{% macro render_data(data, badge_classes) -%}
    {% if data %}
        <span class="{{ badge_classes }}">{{ data }}</span>
    {% endif %}
{%- endmacro %}

{% macro render_header_data(title, data, badge_classes=None) -%}
    <dt>{{ title }}:</dt>
    <dd>
        {% if data %}
            {% if badge_classes %}
                <span class="{{ badge_classes }}">{{ data }}</span>
            {% else %}
                {{ data }}
            {% endif %}
        {% else %}
            -
        {% endif %}
    </dd>
{%- endmacro %}

{% macro render_status_label(status) -%}
    <span class="label label-{{ status }}">{{ status }}</span>
{%- endmacro %}

{% block page_styles %}
    /* Summary */
    .table-summary td {
        vertical-align: top;
    }
    .table-summary td.summary-result {
        width: 170px;
        /*background-color: #f00;/**/
        text-align: center;
        font-size: 30px;
        font-weight: bold;
        padding: 0 5px 10px 30px;
    }
    .table-summary td.summary-result i {
        font-size: 140px;
    }
    .table-summary dl {
        font-size: 16px;
    }
    .table-summary dt, dd {
        line-height: 22px;
    }
    .table-summary dt {
        width: 130px;
    }
    .table-summary dd {
        margin-left: 150px;
    }
    .table-summary .badge {
        font-size: 12px;
    }
    .table-summary .label {
        font-size: 14px;
    }
    /* Monitors */
    .table-monitor {
        margin: 5px 0 20px 0;
    }
    .table-monitor td {
        padding-top: 0;
        padding-bottom: 0;
        color: #666;
    }
    .table-monitor td.name {
        width: 75%;
    }
    .table-monitor td.status {
        width: 15%;
        text-align: center;
        padding-top: 10px;
    }
    .table-monitor td.icon {
        width: 10%;
        text-align: center;
        margin: 0;
        padding: 0;
    }
    .table-monitor a {
        text-decoration: underline;
    }
    .status_OK,
    tr.row_OK i {
        color: #5cb85c;
    }
    .status_FAIL,
    .failure_FAIL h4,
    tr.row_FAIL a,
    tr.row_FAIL td {
        color: #b44541;
    }
    .status_ERROR,
    .failure_ERROR h4,
    tr.row_ERROR a,
    tr.row_ERROR td {
        color: #ff0000;
    }
    tr.row_OK td i {
        font-size: 34px;
        padding-top: 0px;
        padding-left: 4px;
    }
    tr.row_FAIL td i {
        font-size: 34px;
        padding-top: 0px;
        padding-left: 4px;
    }
    tr.row_ERROR td i {
        padding-top: 4px;
        font-size: 32px;
    }
    /* Labels */
    .label-FAIL {
        background-color:  #b94a48;
    }
    .label-ERROR {
        background-color: #ff0000;
    }
    .highlighted {
        background-color: #FFFF00;
        background-color: #fff071;
        background-color: #fff5b9;
        padding: 1px 5px;
        font-style: italic;
    }

    /* Failures */
    div.failure {
        margin-bottom: 40px;
    }
    div.failure .pull-right {
        margin-top: 3px;
    }
    div.failure .highlighted {
        display: inline-block;
        font-size: 14px;
    }
    div.failure pre {
        margin-top: 15px;
    }
    div.failure .description {
        color: #888;
    }
{% endblock %}

{% block page_css %}
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
{% endblock %}

{% block page_content %}
    {#-----------------------------------------------
      TITLE
    ------------------------------------------------#}
    {% call ui.render_title_section() %}
        {{ render_dash_link() }}
        <h1>{{ report_title or 'Report Title' }}</h1>
    {% endcall %}
    {#-----------------------------------------------
      SUMMARY
    ------------------------------------------------#}
    {% call ui.render_section() %}
        <table class="table-summary" cellspacing="0" cellpadding="0" border="0" width="100%">
            <tr>
                {#------------------------
                  VALUES
                ------------------------#}
                <td>
                    {#------------------------
                      JOB OR SPIDER
                    ------------------------#}
                    <dl class="dl-horizontal">
                        {% set items_count = data.stats.get('item_scraped_count', 0) %}
                        {% set requests_count = data.stats.get('downloader/request_count', 0) %}
                        {% set stats_count = data.stats|length %}
                        {% set passed_monitors_count = result.monitors_passed_results|length %}
                        {% set failed_monitors_count = result.monitors_failed_results|length %}
                        {#------------------------
                          JOB
                        ------------------------#}
                        {% if data.job %}
                            {% set is_script = data.job.metadata['spider'].startswith('py:') %}
                            {% set logs_count = data.job.logs.list()|list|length %}
                            {% set log_errors = data.job.logs|get_log_errors %}
                            {% set log_errors_count = log_errors|length %}
                            {% set running_time = data.job.metadata.get('finished_time', 0) - data.job.metadata.get('running_time', 0) %}
                            <dt>
                                {% if is_script %}Script{% else %}Spider{% endif %}:
                            </dt>
                            <dd>
                                <span class="label label-info">
                                    {% if is_script %}
                                        {{ data.job.metadata['spider'][3:] }}
                                    {% else %}
                                        {{ data.job.metadata['spider'] }}
                                    {% endif %}
                                </span>
                            </dd>
                            {% if not is_script %}
                                {{ render_header_data('Version', data.job.metadata['version']) }}
                                {{ render_header_data('Items', items_count, "badge badge-success") }}
                            {% endif %}
                            {{ render_header_data('Errors', log_errors_count, "badge badge-important") }}
                            {% if not is_script %}
                                {{ render_header_data('Requests', requests_count, "badge") }}
                            {% endif %}
                            {{ render_header_data('Logs', logs_count, "badge") }}
                            {{ render_header_data('Stats', stats_count, "badge") }}
                            {{ render_header_data('Running Time', running_time|format_time) }}
                        {#------------------------
                          SPIDER
                        ------------------------#}
                        {% elif data.spider %}
                            {% set log_errors_count = data.stats.get('log_count/ERROR', 0) %}
                            {% set running_time = data.stats.get('finish_time') - data.stats.get('start_time') %}
                            <dt>Spider:</dt>
                            <dd><span class="label label-info">{{ data.spider.name }}</span></dd>
                            {{ render_header_data('Items', items_count, "badge badge-success") }}
                            {{ render_header_data('Errors', log_errors_count, "badge badge-important") }}
                            {{ render_header_data('Requests', requests_count, "badge") }}
                            {{ render_header_data('Stats', stats_count, "badge") }}
                            {{ render_header_data('Running Time', running_time|format_time) }}
                        {% endif %}
                        {#------------------------
                          BOTH
                        ------------------------#}
                        <dt>Monitors:</dt>
                        <dd>
                            {% if passed_monitors_count or failed_monitors_count %}
                                {{ render_data(passed_monitors_count, "badge") }}
                                {{ render_data(failed_monitors_count, "badge badge-important") }}
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                    </dl>
                    {#------------------------
                      JOB ONLY
                    ------------------------#}
                    {% if data.job %}
                        <hr>
                        <dl class="dl-horizontal">
                            <dt>Job:</dt>
                            <dd><span class="label label-info">{{ data.job.key }}</span></dd>
                            {{ render_header_data('State', data.job.metadata['state']) }}
                            {{ render_header_data('Outcome', data.job.metadata['close_reason']) }}
                            {{ render_header_data('Priority', data.job.metadata['priority']) }}
                            {{ render_header_data('Bot Group', data.job.metadata['botgroup']) }}
                            <dt>Tags:</dt>
                            <dd>
                                {% if data.job.metadata['tags'] %}
                                    {% for tag in data.job.metadata['tags'] %}
                                        <span class="label">{{ tag }}</span>
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </dd>
                        </dl>
                    {% endif %}
                </td>
                {#------------------------
                  ICON
                ------------------------#}
                {% if result.all_monitors_passed %}
                    <td class="summary-result status_OK">
                        <i class="fa fa-check-circle fa-3x"></i>
                        <div>All passed!</div>
                    </td>
                {% else %}
                    <td class="summary-result status_FAIL">
                        <i class="fa fa-close fa-3x"></i>
                        <div>{{ result.monitors_failed_results|length }} failed!</div>
                    </td>
                {% endif %}
            </tr>
        </table>
    {% endcall %}
    {#-----------------------------------------------
      MONITORS
    ------------------------------------------------#}
    {% call ui.render_section(top_separator=True) %}
        <h2>Monitors</h2>
        {% if result.monitor_results %}
            {% for group in result.monitor_results|groupby('monitor.monitor_name') %}
                <h3>{{ group.grouper }}</h3>
                <table class="table table-striped table-monitor">
                    {% for result in group.list %}
                        <tr class="row_{{ result.status }}">
                            <td class="name">
                                <h4 title="{{ result.monitor.method_description }}">
                                    {% if result.status != 'OK'  %}
                                        <a href="#failure_{{ result.id }}">{{ result.monitor.method_name }}</a>
                                    {% else %}
                                        {{ result.monitor.method_name }}
                                    {% endif %}
                                </h4>
                            </td>
                            <td class="status">
                                {% if result.status != 'OK'  %}
                                    {{ render_status_label(result.status) }}
                                {% endif %}
                            </td>
                            <td class="icon">
                                {{ render_status_icon(result.status) }}
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            {% endfor %}
        {% else %}
            <div class="alert">
                No monitors defined...
            </div>
        {% endif %}
    {% endcall %}
    {#-----------------------------------------------
      MONITOR FAILURES
    ------------------------------------------------#}
    {% if result.monitors_failed_results %}
        {% call ui.render_section(top_separator=True) %}
            <h1>Monitor Failures</h1>
            {% for group in result.monitors_failed_results|groupby('monitor.monitor_name') %}
                {% for result in group.list %}
                    <div class="failure failure_{{ result.status }}">
                        <div class="pull-right">{{ render_status_label(result.status) }}</div>
                        <a id="failure_{{ result.id }}"></a>
                        <h4>{{ result.monitor.name }}</h4>

                        {% if result.monitor.method_description %}
                            <p class="description">
                                {{ result.monitor.method_description }}
                            </p>
                        {% endif %}
                        {% if result.reason %}
                            <div class="highlighted">{{ result.reason }}</div>
                        {% endif %}
                        <pre>{{ result.error|indent }}</pre>
                    </div>
                {% endfor %}
            {% endfor %}
        {% endcall %}
    {% endif %}
    {#-----------------------------------------------
      STATS
    ------------------------------------------------#}
    {% call ui.render_section(top_separator=True) %}
        <h2>Stats</h2>
        <pre>{{ data.stats|pprint }}</pre>
    {% endcall %}

{% endblock %}
